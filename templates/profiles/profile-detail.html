{% extends 'base.html' %}
{% load static %}
{% block head_css_site %}
    <link rel="stylesheet" href="{% static 'css/profiles/profile-detail.css' %}">
{% endblock head_css_site %}

{% block body_profile %}

<div class="container">
    <div class="profile__overview row">
        <div class="col s4">
            {% if curr_user_profile.avatar %}
                <div class="avatar" style="background-image: url({{curr_user_profile.avatar.url}})">
                </div>
            {% else %}
                <div class="avatar" style="background-image: url({% static 'images/user.png' %})">
                </div>
            {% endif %}
        </div>
        <div class="col s8">
            <div class="overview">
                <div class="row__1" style="display: flex;flex-direction: row;align-items: center;justify-content: space-between;">
                    <h4>{{ curr_user_profile.user.username }}</h4>
                    {% if auth_user_profile == curr_user_profile %}
                        <a href="{% url 'profiles:edit-profile' auth_user_profile.slug %}" class="btn waves-effect waves-light" type="submit" name="action">Edit Profile <i class="fas fa-cog"></i></a>
                    {% elif auth_user_profile in follower_profiles and auth_user_profile not in following_profiles %}
                        <a href="{% url 'chat:chat-room' curr_user_profile.user.username %}" class="btn waves-effect waves-light" type="submit" name="action">Message</a>
                        <a href="{% url 'profiles:user-unfollow' curr_user_profile.slug %}" class="btn waves-effect waves-light" type="submit" name="action">Unfollow</a>
                    {% elif curr_user_profile in my_request_profiles %}
                        <a class="btn waves-effect waves-light" type="submit" name="action">Requested <i class="fas fa-check"></i></a>
                    {% elif auth_user_profile not in following_profiles %}
                        <a href="{% url 'profiles:user-follow' curr_user_profile.slug %}" class="btn waves-effect waves-light" type="submit" name="action">Follow</a>
                    {% elif auth_user_profile in follower_profiles and curr_user_profile in auth_user_follower_profiles %}
                        <a href="{% url 'chat:chat-room' curr_user_profile.user.username %}" class="btn waves-effect waves-light" type="submit" name="action">Message</a>
                        <a href="{% url 'profiles:user-unfollow' curr_user_profile.slug %}" class="btn waves-effect waves-light" type="submit" name="action">Unfollow</a>
                    {% elif auth_user_profile not in follower_profiles and curr_user_profile in auth_user_follower_profiles %}
                        <a href="{% url 'profiles:user-follow' curr_user_profile.slug %}" class="btn waves-effect waves-light" type="submit" name="action">Follow Back</a>
                    {% endif %}
                </div>
                <div class="row__2">
                    <p>0 posts</p>
                    <a class="modal-trigger" data-target="modal1">{{ total_followers }} followers</a>
                    <a class="modal-trigger" data-target="modal2">{{ total_followings }} following</a>
                </div>
                <div class="row__3">
                    <p>{{curr_user_profile.first_name}} {{curr_user_profile.last_name}}</p>
                    <p>{{ curr_user_profile.bio }}</p>
                </div>
            </div>
        </div>
    </div>
    <!--START OF FOLLOWERS MODEL-->
        <div id="modal1" class="modal modal-fixed-footer" style="border-radius: 30px; width: 500px">
            <div class="modal-content">
                <div class="fol__header">
                    <h4>Followers</h4>
                </div>
                <div>
                    {% for follower in followers %}
                        <div class="fol__detail">
                            <a href="{% url 'profiles:profile-detail-view' follower.sender.slug %}">
                                <div style="display: flex; align-items: center;">
                                    {% if follower.sender.avatar %}
                                        <p class="fol__avatars" style="background-image:url({{follower.sender.avatar.url}})"></p>
                                    {% else %}
                                        <p class="fol__avatars" style="background-image:url({% static 'images/user.png' %})"></p>
                                    {% endif %}
                                    <p style="padding-left: 20px">{{follower.sender.user.username}}</p>
                                </div>
                            </a>
                            <div>
                                {% if auth_user_profile != follower.sender %}
                                    {% if follower.sender in auth_user_following_profiles %}
                                        <button class="btn">Following</button>
                                    {% elif follower.sender in my_request_profiles %}
                                        <button class="btn">Requested <i class="fas fa-check"></i></button>
                                    {% else %}
                                        <a href="{% url 'profiles:user-follow' follower.sender.slug %}" class="btn" style="color:white;">Follow</a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
            </div>
        </div>
    <!--END OF FOLLOWERS MODEL-->
    <!--START OF FOLLOWING MODEL-->
        <div id="modal2" class="modal modal-fixed-footer" style="border-radius: 30px; width: 500px">
            <div class="modal-content">
                <div class="fol__header">
                    <h4>Following</h4>
                </div>
                <div>
                    {% for following in followings %}
                        <div class="fol__detail">
                            <a href="{% url 'profiles:profile-detail-view' following.receiver.slug %}">
                                <div style="display: flex; align-items: center;">
                                    {% if following.receiver.avatar %}
                                        <p class="fol__avatars" style="background-image:url({{following.receiver.avatar.url}})"></p>
                                    {% else %}
                                        <p class="fol__avatars" style="background-image:url({% static 'images/user.png' %})"></p>
                                    {% endif %}
                                    <p>{{following.receiver.user.username}}</p>
                                </div>
                            </a>
                            <div>
                                {% if auth_user_profile != following.receiver %}
                                    {% if following.receiver in auth_user_following_profiles %}
                                        <button class="btn">Following</button>
                                    {% elif following.receiver in my_request_profiles %}
                                        <button class="btn">Requested <i class="fas fa-check"></i></button>
                                    {% else %}
                                        <a href="{% url 'profiles:user-follow' following.receiver.slug %}" class="btn" style="color:white;">Follow</a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
            </div>
        </div>
    <!--END OF FOLLOWING MODEL-->
    {% if form %}
        <div class="row">
            <div class="create" style="display:flex;flex-direction:row;justify-content:center;">
                <form method="post" class="z-depth-2" style="display:flex;flex-direction:column;background-color: #242526;padding:25px;border-radius:max(0px, min(8px, calc((100vw - 4px - 100%) * 9999))) / 8px;color:white !important;">
                    {% csrf_token %}
                    {{form.as_p}}
                    <button type="submit" class="btn">POST</button>
                </form>
            </div>
        </div>
    {% endif %}
    <div>
        <div class="divider"></div>
        <ul id="tabs-swipe-demo" class="tabs">
            <li class="tab col s3"><a href="#test-swipe-1">POSTS</a></li>
            {% comment %} <li class="tab col s3"><a class="active" href="#test-swipe-2">SAVED</a></li> {% endcomment %}
        </ul>
        <div class="divider"></div>
        <div id="test-swipe-1" class="col s12">
            <div class="container infinite-container">
                {% include 'posts/post_ajax.html' %}
            </div>
            {% comment %} {% if posts.has_next %}
                <a class="infinite-more-link" href="?page={{ posts.next_page_number }}"></a>
            {% endif %}
            <div style="display:flex;flex-direction:row;justify-content:center">
                <div class="loading" style="display: none;">
                    <div class="preloader-wrapper big active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> {% endcomment %}
        </div>
        {% comment %} <div id="test-swipe-2" class="col s12">
            <h2>SAVED</h2>
        </div> {% endcomment %}
    </div>
</div>

{% endblock body_profile %}

{% block domready %}
    $('a.like').click(function(e){
            e.preventDefault();
            var previous_action = $(this).data('action');
            var like_button = $(this);
            console.log(previous_action);
            console.log(like_button.find('span'));
            $.ajax({
                type: 'POST',
                url: '{% url "posts:like" %}',
                data: {
                    id: $(this).data('id'),
                    action: $(this).data('action')
                },
                success: function(data){
                    if (data['status'] == 'ok')
                    {
                        // toggle data-action
                        like_button.data('action', previous_action == 'like' ?
                        'unlike' : 'like');
                        // toggle link text
                        if(like_button.data('action') == 'like') {
                            like_button.html(`<i class="far fa-heart"></i><span> ${data.total_likes}</span>`);
                        } else {
                            like_button.html(`<i class="fas fa-heart"></i><span> ${data.total_likes}</span>`);
                        }
                    }
                },
                error: function (response) {
                    console.log('error')
                }
            });
        });

        $(".comment-form").submit(function (e) {
            e.preventDefault();
            var serializedData = $(this).serialize();
            var comment_list = $(this).parent().prev().children().children().find('#all_comments');
            var comment_input = $('#id_text');
            var form = $(this);
            var total_comments_el = $(this).parent().prev().children().children().children().children()[0];
            var total_comments = $(this).parent().prev().children().children().children().children()[0].textContent;
            const total = parseInt(total_comments) + 1;
            $.ajax({
                type: 'POST',
                url: "{% url 'posts:comment' %}",
                data: serializedData,
                success: function (response) {
                    console.log(form);
                    form.trigger('reset');

                    var instance = JSON.parse(response["instance"]);
                    var text = instance[0]["fields"]["text"];
                    var avatar_url = instance[1]["fields"]["avatar"];
                    var username = instance[2]["fields"]["username"];
                    console.log(text);
                    console.log(avatar_url);
                    console.log(username);

                    comment_list.append( 
                        `<div class="comment">
                            <div class="comment-user" style="background-image:url(${avatar_url?"/media/"+avatar_url:"{% static 'images/user.png' %}"}); height: 30px;width: 30px;background-size: cover;border-radius: 50%;">
                            </div>
                            <div class="comment-content">
                                <div style="padding:10px;color:rgba(255,255,255, 0.85);">
                                    <p style="font-size:18px; color:#64ffda !important;">${username}</p>
                                    <p>${text}</p>
                                </div>
                            </div>
                        </div>`
                    )
                    total_comments_el.textContent = total;
                },
                error: function (response) {
                    console.log('error')
                }
            })
        });

        $('.delete').click(function(e) {
            e.preventDefault();
            console.log($(this).parent().parent().parent().parent()[0]);
            var id = $(this).data('id');
            var post_node = $(this).parent().parent().parent().parent()[0];
            $.ajax({
                type: 'POST',
                url: "{% url 'posts:delete' %}",
                data:
                {
                    id: $(this).data('id')
                },
                success: function(data) {
                    post_node.remove();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });
{% endblock domready %}